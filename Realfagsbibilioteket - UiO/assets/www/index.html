<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1; user-scalable=no" />
		<title></title>
		<link rel="stylesheet" href="https://ajax.aspnetcdn.com/ajax/jquery.mobile/1.1.1/jquery.mobile-1.1.1.min.css"
		/>
		<link rel="stylesheet" href="my.css" />
		<style>
			/* App custom styles */

		</style>
		<script src="hyllesystem.js"></script>
		<script src="jquery.min.js"></script>
		<script type="text/javascript" src="jquery.autocomplete.js"></script>
		<script src="cordova-2.0.0.js"></script>
		<script src="barcodescanner.js"></script>
		<script type="text/javascript" charset="utf-8" src="share.js" ></script>
		<script src="handlebars-1.0.0.beta.6.js"> </script>		
		<script>
	
		
			//cursor functions
			 
			//set cursor position
			$.fn.setCursorPosition = function(position){
				if(this.length == 0) return this;
				return $(this).setSelection(position, position);
			};
			 
			//set selection range
			$.fn.setSelection = function(selectionStart, selectionEnd) {
				if(this.length == 0) return this;
				input = this[0];
			 
				if (input.createTextRange) {
					var range = input.createTextRange();
					range.collapse(true);
					range.moveEnd('character', selectionEnd);
					range.moveStart('character', selectionStart);
					range.select();
				} else if (input.setSelectionRange) {
					input.focus();
					input.setSelectionRange(selectionStart, selectionEnd);
				}
			 
				return this;
			};		
		
			if (window.location.href.indexOf("saq") > -1 || window.location.href.indexOf("mohamsi") > -1) {
				window.JSONP = "jsonp=?";
			} else {
				window.JSONP = "";
			}
		
			Handlebars.registerHelper('listauthors', function(context, block) {
				return context.map(function(item) {
					return item.presentableName;
				}).join(", ");
			});
			
			Handlebars.registerHelper('listisbn', function(context, block) {
				return context.map(function(item) {
					return item;
				}).join(", ");
			});
		
			Handlebars.registerHelper('bookformat', function(context, block) {
				return context == "electronic" ? "Electronic" : "Printed";
			});
			
			Handlebars.registerHelper('pluralize', function(number, single, plural) {
				if (number === 1) { 
					return single; 
				}
				else { 
					return plural; 
				}
			});
			
			Handlebars.registerHelper('ifCond', function(v1, v2, options) {
			  if(v1 == v2) {
				return options.fn(this);
			  } else {
				return options.inverse(this);
			  }
			});			

			Handlebars.registerHelper('unlessCond', function(v1, v2, options) {
			  if(v1 != v2) {
				return options.fn(this);
			  } else {
				return options.inverse(this);
			  }
			});
			
		</script>

		<script id="search_result_book_template" type="text/x-handlebars-template">
			{{#if documents.length}}
			
				<div id="search_results_count">{{this.totalHits}} {{pluralize this.totalHits "result" "results"}}</div>
				<ul data-role="listview" data-divider-theme="b" data-inset="false" id="search_results">
					{{#each documents}}
							<li data-theme="c">
								<a href="#page_books?{{this.recordId}}"  data-transition="slide">
									<h3>{{this.title}}</h3>
									<p>{{#listauthors this.creators}}{{/listauthors}}</p>
									<p class="ui-li-aside"><strong>{{this.year}}</strong>{{#ifCond this.material "electronic"}}<img src="ebook-icon.png"/>{{/ifCond}}</p>
								</a>
							</li>
					{{/each}}
				</ul>
			{{else}}
			<div class="no_books">No search results found for &quot{{this.query}}&quot, check your spelling or try a less specific search.</div>
			{{/if}}
		</script>
		
		<script id="favorites_list_template" type="text/x-handlebars-template">
			{{#if documents.length}}
				
				<ul data-role="listview" data-divider-theme="b" id="favorites_list" data-filter="true" data-filter-placeholder="Search favorites..." data-filter-theme="d" data-split-icon="delete" data-split-theme="d" data-inset="false">
				
					{{#each documents}}
							<li data-theme="c">
								<a href="#page_books?{{this.recordId}}"  data-transition="slide">
									<h3>{{this.title}}</h3>
									<p>{{#listauthors this.creators}}{{/listauthors}}</p>
									<p class="ui-li-aside"><strong>{{this.year}}</strong>{{#ifCond this.material "electronic"}}<img src="ebook-icon.png"/>{{/ifCond}}</p>
									<a href="#favorite_delete?{{this.recordId}}" data-rel="dialog" data-transition="none">Delete favorite</a>
								</a>
							</li>
					{{/each}}
				</ul>
			{{else}}
				<div class="no_favorites_message text-align-center"><br>You have no books saved as favorites.<br><br>You can save a book as a favorite when you are viewing it, by tapping the star next to the book title.<br> <br>When you save books as favorites they will be listed here.</div>
			{{/if}}
		</script>
		
		<script id="book_info_template" type="text/x-handlebars-template">
					<h3><a href="" id="fav_star_button_link">
					<img id="fav_star_button" src="star_empty.png"/>
				</a>{{this.title}}</h3>
					<p>by {{#listauthors this.creators}}{{/listauthors}}</p>
					<div class="ui-grid-a">
						<div class="ui-block-a">
							Year:
						</div>
						<div class="ui-block-b">
							{{this.year}}
						</div>
						<div class="ui-block-a">
							ISBN:
						</div>
						<div class="ui-block-b">
							{{#listisbn this.isbn}}{{/listisbn}}
						</div>
						<div class="ui-block-a">
							Edition:
						</div>
						<div class="ui-block-b">
							{{this.edition}}
						</div>	
										
						<div class="ui-block-a"> 
							Format:
						</div>
						<div class="ui-block-b">
							{{#bookformat this.material}}{{/bookformat}}
						</div>

						{{#unlessCond this.material "electronic"}}	
						<div class="ui-block-a"> 
							Location:
						</div>
						<div class="ui-block-b">
							{{this.collection}}{{#if this.collection}},{{/if}} {{this.callnumber}}
						</div>
						{{/unlessCond}}
					</div>		
		</script>		
		<script src="lawnchair-0.6.1.min.js"> </script>
		<script src="query.js"></script>
		<script>
			window.BookWorms = { searchCache: {}};
			$(document).bind("mobileinit", function(){
			
				//window.share = new Share();
				$.mobile.defaultPageTransition = "none";
				window.DB =  new Lawnchair(function(){});
				window.FavHistory = [];
				DB.get("favhistory",function(d){
					if (d != null) {
						window.FavHistory = d.history;
					}
				});
				$.each(FavHistory, function (i, el) {
					DB.get(el, function(d){
						//console.log(el,d);
						window.BookWorms.searchCache[el] = d.doc;
						//console.log("cache",window.BookWorms.searchCache);
					});
				});
				
				window.BookWorms.includeEbooks = "on";
				DB.get("includeebooks", function(d) {
					if (d != null) {
						window.BookWorms.includeEbooks = d.status;
					}
				});
				
				$.ajaxSetup({
					timeOut: 10000,
				  
					error: function(jqXHR, textStatus, errorThrown) {
						alert("There was an error connecting to the server, please check your internet connection.");
				  		$.mobile.hidePageLoadingMsg();
						$('#block-ui').hide();
				  	}
				});
			});
	
		</script>
		<script src="jquery.mobile-1.1.1.min.js">
			
		</script>
		<script>
		
			$(document).bind("pageshow", function(e,data) {

				$(this).addClass('ui-page-active');
				$.mobile.hidePageLoadingMsg();
				$('#block-ui').hide();
			});
		
			// Listen for any attempts to call changePage().
			$(document).bind( "pagebeforechange", function( e, data ) {
				

				// We only want to handle changePage() calls where the caller is
				// asking us to load a page by URL.

				if ( typeof data.toPage === "string" ) {

					//window.BookWorms.nextPage = data.toPage;
					// We are being asked to load a page by URL, but we only
					// want to handle URLs that request the data for a specific
					// category.
					var u = $.mobile.path.parseUrl( data.toPage ),
						re = /^#page_search_results/;

					if ( u.hash.search(re) !== -1 ) {

						// We're being asked to display the items for a specific category.
						// Call our internal method that builds the content for the category
						// on the fly based on our in-memory category data structure.
						$.mobile.showPageLoadingMsg();
						$('#block-ui').show();
						getSearchResults(u, data.options);
						
						// Make sure to tell changePage() we've handled this call so it doesn't
						// have to do anything.
						e.preventDefault();
						return false;
					}
					
					re = /^#page_books/;
					if ( u.hash.search(re) !== -1 ) {

						// We're being asked to display the items for a specific category.
						// Call our internal method that builds the content for the category
						// on the fly based on our in-memory category data structure.
						$.mobile.showPageLoadingMsg();
						$('#block-ui').show();
						getBook(u, data.options);

						// Make sure to tell changePage() we've handled this call so it doesn't
						// have to do anything.
						e.preventDefault();
						return false;
					}
					
					if (u.hash == "#page_favorites") {
						//$.mobile.showPageLoadingMsg();
						//$('#block-ui').show();
						showFavorites(u, data.options);
						return;
					}
					
					re = /^#favorite_delete/;
					
					if (u.hash.search(re) !== -1) {
						//console.log(1);
						updateFavDeleteDialog(u, data.options);
						return;
					}
					
					if (u.hash == "" || u.hash == "#page_home") {
						updateHomeFavorites();
						return;
					}
				/*	
					if (u.hash == "#page_search") {
						$("#no_books").html("");
						$('#searchinput1').val("");
					//	if (window.a)
					//		$(window.a.container).scrollTop(0);
					}
					*/
					if (u.hash == "#page_map" || u.hash == "#page_book_directions") {
						var b = window.BookWorms.currentBook;
						//console.log(b);
						var subject = b.collection;
						if (BookCollections[b.collection] == undefined) {
							alert("This subject has not been mapped for the protoype, try a book in Physics instead");
							e.preventDefault();
							return false;							
						} else {
							var callnr = b.callnumber;
							var emnenr = callnr.split(" ")[0];
							var locnr = callnr.split(" ")[1];
							var emne = BookCollections[b.collection][emnenr];
							//console.log(emne);
							var section;
							var shelf;
							$.each(emne.sectionmap, function(key,value) {
								//console.log(key,value);
								if (value.start <= locnr && value.end >= locnr) {
									//console.log(key);
									section = key;
									return false;
								}
							});
							//console.log(section);
							
							$.each(emne.sectionmap[section].shelves, function(key,value) {
								//console.log(key);
								if (value.start <= locnr && value.end >= locnr) {
									shelf = key;
								}
							});
							
							//console.log(shelf);
							//$("#map_shelf_loc").html("Section: " + section + ", shelf: " + shelf);
							$("#book_map_large").attr("src", "images/vertical/hylle" + section + ".png" );
							
						}
					}
					
				}
			});		
			
			$("#page_home").live('pagebeforecreate',function(event) {
				updateHomeFavorites();
				$("#home_search_box").bind('mouseover', function(){
				   return false;
				});
				
			$('#home_search_button').bind('click', function (e) {
				e.preventDefault();
				var term = $('#searchinput2').val();
				//console.log(term);
				if (term == "")
					return false;
				if (window.b)
					window.b.container.hide();
				
				$.mobile.changePage(getAppSearchUrl(term,0));
				return false;
			});
			
			$("#home_search_form").submit(function(e){
				window.b.container.hide();
				e.preventDefault();
				return false;
			});
			
			
			$('#home_search_form').submit(function() {
				$("#home_search_button").trigger("click");
			});				
				
			});
			
			
			$("#page_home").live('pageshow',function(event) {
				if(!window.autoCompleteInit2) {
					//var options = {'serviceUrl' : "https://ask.bibsys.no/ask2/json/autocompleteProxy.jsp?jsonp=?","index":"title", minChars: 3};
					var options = {'serviceUrl' : "https://ask.bibsys.no/ask2/json/autocompleteProxy.jsp?"+window.JSONP,"index":"title", minChars: 3};
					window.b = $("#searchinput2").autocomplete(options);
					//alert(window.a);
					window.autoCompleteInit2 = true;
				}
				$("#searchinput2").val("");
			});
			
			$("#page_search_results").live('pagebeforeshow', function(event) {
				//console.log(1);
				$('#ebook_toggle').val(window.BookWorms.includeEbooks).slider("refresh");
				
			});
			
			$("#page_search_results").live('pageshow', function(event) {
				//console.log(event);
				$(this).addClass('ui-page-active');
				//console.log(2);
				if(!window.autoCompleteInit) {
					//var options = {'serviceUrl' : "https://ask.bibsys.no/ask2/json/autocompleteProxy.jsp?jsonp=?","index":"title", minChars: 3};
					var options = {'serviceUrl' : "https://ask.bibsys.no/ask2/json/autocompleteProxy.jsp?"+window.JSONP,"index":"title", minChars: 3};
					window.a = $("#searchinput1").autocomplete(options);
					//alert(window.a);
					window.autoCompleteInit = true;
				}
				$(document).scrollTop(0);
			});
		</script>
		<script src="my.js">
		
		</script>
		

		<script id="home_favorites_template" type="text/x-handlebars-template">		
					<li data-role="list-divider" role="heading">Favorites <img src="star.png" class="list_decorator ui-li-thumb" width="24px" /> </li>
					{{#if favorites.length}}
					{{#each favorites}}
					<li data-theme="c">
						<a href="#page_books?{{this.recordId}}" data-transition="slide">{{this.title}}</a>
					</li>
					{{/each}}
					<li data-theme="c">
						<a href="#page_favorites" data-transition="slide">More...</a>
					</li>
					{{else}}
					<li class="no_fav_text">When you save books as favorites they will be listed here.<br>You can save a book as a favorite by tapping the star next to the book title.</li>
					
					{{/if}}
		</script>
		
		<script id="directions_bookinfo_template" type="text/x-handlebars-template">
			<b>{{this.title}}</b><br>
			by {{#listauthors this.creators}}{{/listauthors}}<br><br>
			
			Location: 2nd floor, {{this.collection}}{{#if this.collection}},{{/if}} {{this.callnumber}}<br><br>
			Shelf: {{this.shelf}}
		</script>
	</head>
	<body>
		<!-- Home -->
		<div data-role="page" id="page_home">
			<div data-theme="a" data-role="header" data-position="fixed" data-id="foo">
				<a class="logo_home_button header_button" href="javascript:;"><img src="uio_segl.png" width="50px"/></a>
				<h3>UiO<img class="colon" src="colon.png" width="9px"/>Realfagsbibilioteket</h3>
				
			</div>
			
			<div data-role="content" style="padding:5px 5px 5px 5px" id="home_menugrid">
			
				<div id="home_search_box" class="ui-btn ui-btn-corner-all ui-btn-up-c" href="#" data-corners="true" data-shadow="true" data-iconshadow="true" data-iconsize="18" data-wrapperels="span" data-theme="c">
					<span class="ui-btn-inner ui-btn-corner-all">
						<div id="search_icon_container">
							<div id="book_icon_box"><img src="images/search_books.png" width="60px" height="65px"/></div>
							<div class="ui-btn-text" id="book_icon_text_box">Search for<br>books</div>
						</div>
						<form id="home_search_form" style="clear:both">
							<input name="search" id="searchinput2"
									placeholder="name, author or ISBN" value="" type="search" />
							<a id="home_search_button" data-role="button">Search</a>
						</form>
					</span>
				</div>
			
					<!--
					<div>
						<a href="#page_search_results" data-role="button" class="">Find books /<br>ebooks</a>
					</div>
					-->
				<div class="ui-grid-a menu_grid" >
					<div class="ui-block-a">
						<a href="#page_locationhours" data-transition="slide" data-role="button">
							<div class="icon_button_container">
								<img src="images/location.png"/>
								<p>Location<br/>and hours</p>
							</div>
						</a>						
					</div>
					<div class="ui-block-b">
						<a href="#"  onclick="scanBarcode();" data-role="button">
							<div class="icon_button_container">
								<img src="images/scan_barcode.png"/>
								<p>Scan<br/>barcode</p>
							</div>
						</a>
					</div>					

					<div class="ui-block-a ui-disabled">
						<a href="#" data-transition="slide" data-role="button">
							<div class="icon_button_container">
								<img src="images/syllabus.png"/>
								<p>Syllabus<br/>books</p>
							</div>
						</a>
					</div>
					<div class="ui-block-b">
						<a href="#page_librarynews" data-transition="slide" data-role="button">
							<div class="icon_button_container">
								<img src="images/news.png"/>
								<p>News from<br/>the library</p>
							</div>
						</a>
					</div>
				</div>
				<div style="padding: 0 10px 10px 10px">
				<ul data-role="listview" data-divider-theme="a" data-inset="false" id="home_favorites">
					<li data-role="list-divider" role="heading">Favorites <img src="star.png" width="24px" /></li>
										
				</ul>
				</div>
			</div>
		</div>

		
        <!-- Search results -->
        <div data-role="page" id="page_search_results">
			<div data-theme="a" data-role="header" data-position="fixed" data-id="foo">
				<a class="logo_home_button header_button" href="index.html" data-direction="reverse"><img src="uio_segl_arrow.png" width="50px"/></a>
				<h3>Search</h3>
				
			</div>
            <div data-role="content" style="padding: 15px 15px 10px">
            	<div id="search_form_results">
					<form id="search_page_form">
						<div data-role="fieldcontain">
							<fieldset >
								<div id="search_field_box">
									<input name="search" id="searchinput1"
									placeholder="name, author or ISBN" value="" type="search" />
								</div>
								<div id="ebook_toggle_box">				
									<select name="flip-min" id="ebook_toggle" data-theme="a" data-role="slider">
										<option value="off">no ebooks</option>
										<option value="on">with ebooks</option>
									</select>
								</div>
								<div id="search_button_box">
									<!--<input type="submit" data-theme="a" value="Search" id="search_button"/>-->
									<a href="javascript:;" data-role="button" data-theme="a" id="search_button">Search</a>
								</div>
							</fieldset>
						</div>	
					</form>
					<div id="no_books"></div>
				</div>
                <div id="search_results_container"></div>
                <div class="ui-grid-b" id="search_results_nav">
                    <div class="ui-block-a">
                        <a data-role="button" data-direction="reverse"  href="#page1" data-icon="arrow-l" data-iconpos="left" id="prev_search_button"  data-transition="none">
                            Previous
                        </a>
                    </div>
                    <div class="ui-block-b" id="search_page_nr">
                    	1 of 5
                    </div>
                    <div class="ui-block-c">
                        <a data-role="button"  href="#page1" data-icon="arrow-r" data-iconpos="right"  id="next_search_button"  data-transition="none">
                            Next
                        </a>
                    </div>
                </div>
            </div>
        </div>		

        <!-- Books -->
		<div data-role="page" id="page_books">
			<div data-theme="a" data-role="header" data-position="fixed" data-id="foo">
				<a class="logo_home_button header_button" href="index.html" data-direction="reverse"><img src="uio_segl_arrow.png" width="50px"/></a>
				<h3>Description</h3>
				<a class="search_button header_button" href="#page_search_results"><img src="search.png" width="26px"/></a>
			</div>
			<div data-role="content" style="padding: 15px">
				<div id="book_info"></div>
				<div id="status_indicators">
					<div class="available_indicator"><img src="available.png" width="35px"/> Available</div>
					<div class="unavailable_indicator"><img src="unavailable.png" width="35px"/> Unavailable</div>
					<div class="ordered_indicator"><img src="unavailable.png" width="35px"/> On order</div>
				</div>

				<a id="button_where_is_it" data-role="button" data-transition="fade" data-theme="c" href="#page_book_directions">
					Where is it?<img src="map_icon_3.png" class="book_action_button"/>
				</a>
																		
				<a id="button_how_to_access"data-role="button" data-transition="fade" data-theme="c" href="javascript:;">
					How to access it?
				</a>
				
				<a data-role="button" data-transition="fade" href="#" onclick="shareBook();">
					Share<img src="share_small.png" id="book_share_button" class="book_action_button"/>
				</a>
			</div>
		</div>		

        <!-- Favorites -->
		<div data-role="page" id="page_favorites">
			<div data-theme="a" data-role="header" data-position="fixed" data-id="foo">
				<a class="logo_home_button header_button" href="index.html" data-direction="reverse"><img src="uio_segl_arrow.png" width="50px"/></a>
				<h3>Favorites<img src="star.png" class="favicon" width="24px" /></h3>
				<a class="search_button header_button" href="#page_search_results" data-transition="slide"><img src="search.png" width="26px"/></a>
			</div>
			<div data-role="content" style="padding: 15px">
				<div id="favlist_container"></div>
			</div>
		</div>	

		<div data-role="page" id="favorite_delete">
			<div data-role="header" data-theme="d">
				<h1>Delete?</h1>
			</div>

			<div data-role="content" data-theme="d">
				<h4 class="text-align-center">Do you want to delete<br> &quot;<span id="delete_book_title"></span>&quot;<br> from your favorites?</h4>
				<a href="javascript:;" data-role="button" data-rel="back" data-theme="b" id="fav_delete_button">Delete</a>
				<a href="javascript:;" data-role="button" data-rel="back">Cancel</a>
			</div>
		</div>
		
		<!-- How to scan bar code-->
		<div data-role="page" id="how_to_scan">
			<div data-role="header" data-theme="d">
				<h1>How to scan the barcode</h1>
			</div>

			<div data-role="content" data-theme="d">
				
				<ul id="how_to_scan_desc">
					<li>Hold your mobile so that the entire barcode is located in the inner field, as shown below.</li>
					<li>Do not move the phone, it will automatically read the barcode when it has focused.</li>
				</ul>
				
				<img src="images/howToScanBarcode.png" width="100%" />
				<input type="checkbox" name="checkbox-scanhelp" id="checkbox-scanhelp" class="custom" />
				<label for="checkbox-scanhelp">Don't show this again</label>
				<a href="javascript:;" data-role="button" data-rel="back" data-theme="b" id="scan_ok_button">Scan now</a>
			</div>
		</div>		

        <!-- Location and hours -->
		<div data-role="page" id="page_locationhours">
			<div data-theme="a" data-role="header" data-position="fixed" data-id="foo">
				<a class="logo_home_button header_button" href="index.html" data-direction="reverse"><img src="uio_segl_arrow.png" width="50px"/></a>
				<h3>Location and hours</h3>
				<a class="search_button header_button" href="#page_search_results" data-transition="slide"><img src="search.png" width="26px"/></a>
			</div>
			<div data-role="content" style="padding: 15px">
				<h2 class="text-align-center">Vilhelm Bjerknes' Hus</h2>
				<div class="text-align-center">
				<a href="https://maps.google.com/maps?q=Vilhelm+Bjerknes+Hus,+Universitas+Regia+Fredericiana+0851+Oslo,+Norway&hl=en&ie=UTF8&ll=59.939977,10.723171&spn=0.004455,0.010686&sll=59.940176,10.723223&sspn=0.00891,0.021372&hnear=Vilhelm+Bjerknes+Hus,+Ullev%C3%A5l,+0851+Oslo,+Norway&t=m&z=17"><img src="images/map.png" width="80%"/></a>
				<div style="text-align:left;width:80%;margin: 0 auto;">
				<h3>Address:</h3>
				Motke Moes vei 35,<br>
				0315, Oslo,<br>
				Norway<br><br>
				<h3>Opening hours:</h3>
				Monday-Friday: 08.00-22.00<br>
				Saturday-Sunday: 10.00-18.00<br><br>
				</div>				
				</div>

			</div>
		</div>	
		
		
        <!-- News from your library -->
		<div data-role="page" id="page_librarynews">
			<div data-theme="a" data-role="header" data-position="fixed" data-id="foo">
				<a class="logo_home_button header_button" href="index.html" data-direction="reverse"><img src="uio_segl_arrow.png" width="50px"/></a>
				<h3>News from your library</h3>
				<a class="search_button header_button" href="#page_search_results" data-transition="slide"><img src="search.png" width="26px"/></a>
			</div>
			<div data-role="content" style="padding: 15px">
				<ul data-role="listview" data-inset="true">
					<li class="ui-disabled"><a href="javascript:;">Events</a></li>
					<li class="ui-disabled"><a href="javascript:;">News</a></li>
				</ul>
			</div>
		</div>		



		
        <!-- Book Directions -->
		<div data-role="page" id="page_book_directions">
			<div data-theme="a" data-role="header" data-position="fixed" data-id="foo">
				<a class="logo_home_button header_button" href="index.html" data-direction="reverse"><img src="uio_segl_arrow.png" width="50px"/></a>
				<h3>Directions</h3>
				<a class="search_button header_button" href="#page_search_results"><img src="search.png" width="26px"/></a>
			</div>
			<div data-role="content" style="padding: 15px">
				<div>
					<a id="zoom_map" href="#page_map" data-role="button" data-inline="true" data-theme="a" data-icon="fullscreen" data-iconpos="right">zoom</a>
					<a href="#page_map" data-transition="fade">
						<img id="book_map" src="" width="100%"/>
					</a>
				</div>
				<div id="directions_book_info"></div>
				<div>
					<img id="book_shelf_map" src="" height="125px" />
				</div>
			</div>
		</div>	
	

        <!-- IMAGE -->
		<div data-role="page" id="page_map">
			
			<div data-role="content">
				<!--<a id="map_shelf_loc"></a>-->
				<a id="close_map" href="#" data-rel="back" data-role="button" data-inline="true" data-theme="a" data-icon="delete" data-iconpos="right">close</a>
				<img id="book_map_large" src="" width="100%" />
			</div>
		</div>

		<div id="block-ui">
		</div>
		
		<script>
						
			
			function getBook(urlObj, options) {
				var recordId = urlObj.hash.split("?")[1];
				if (window.BookWorms.searchCache[recordId] != undefined) {
					getDetailedBookInfo({result:{documents : [window.BookWorms.searchCache[recordId]]}}, urlObj, recordId,options);
				} else {
					//XXX add timestamp
					//var url = "https://ask.bibsys.no/ask2/json/result.jsp?jsonp=?" + "&cql=bs.objektid%3D%22" + recordId + '%22%20AND%20(bs.avdeling%20=%20"UREAL")';
					var url = "https://ask.bibsys.no/ask2/json/result.jsp?" + window.JSONP + "&cql=bs.objektid%3D%22" + recordId + '%22%20AND%20(bs.avdeling%20=%20"UREAL")';
					$.getJSON(url, function (data) {
						getDetailedBookInfo(data,urlObj,recordId,options);
					})
					.error(function(){
						$.mobile.hidePageLoadingMsg();
						$('#block-ui').hide();
					});
					
				}
			}
		
			function getDetailedBookInfo(data, urlObj, recordId, options) {
				
				var baseURI = "https://ask.bibsys.no/ask2/json/items.jsp?objectid=";
				//var jsonp = "&jsonp=?";
				//var jsonp = "";
	
				$.getJSON(baseURI + encodeURIComponent(recordId) + "&" + window.JSONP, function(mydata) {
					var docs = mydata.result.documents;
					var filtered = $.grep(docs, function(n, i) {
						return n.institutionsection == "UREAL" ? true : false;
					});
					//XXX only showing first book
		
					var book = filtered[0];
					
					data.result.documents[0] = $.extend(data.result.documents[0], book);
					
					showBook(data, urlObj, recordId, options);
		
				});				
			}

			function getSectionForCurrentBook() {
				var b = window.BookWorms.currentBook;
				//console.log(b);
				var subject = b.collection;
				if (BookCollections[b.collection] == undefined) {
					//alert("This subject has not been mapped for the protoype, try a book in Physics instead");
					//e.preventDefault();
					//return false;
					return [];							
				} else {
					var callnr = b.callnumber;
					var emnenr = callnr.split(" ")[0];
					var locnr = callnr.split(" ")[1];
					var emne = BookCollections[b.collection][emnenr];
					//console.log(emne);
					var section;
					var shelf;
					//console.log(locnr,emne);
					$.each(emne.sectionmap, function(key,value) {
						//console.log(key,value);
						if (value.start <= locnr && value.end >= locnr) {
						//	console.log(0,key);
							section = key;
							return false;
						} else {
						//	console.log(key,value.start);
						//	console.log(key,value.end);
						}
					});
					//console.log(section);		
					$.each(emne.sectionmap[section].shelves, function(key,value) {
						//console.log(key);
						if (value.start <= locnr && value.end >= locnr) {
							shelf = key;
						}
					});
							
				return [section,shelf];
									}
			}

			function showBook(data, urlObj,recordId,options) {
				console.log(data);
				//console.log(recordId);
				window.BookWorms.searchCache[recordId] = data.result.documents[0];
				window.BookWorms.currentBook = data.result.documents[0];
				//console.log(BookWorms.searchCache);
				var $page = $("#page_books");
				var source = $("#book_info_template").html();
				var template = Handlebars.compile(source);
				var html = template(data.result.documents[0]);
				$page.page();
				$("#book_info").html(html);
				
				var fav = false;
				DB.exists(recordId, function(exists) {
					if(exists) {
						fav = true;
						};
					});				
				$("#fav_star_button").attr("src", fav ? "star.png" : "star_empty.png");
				
				$("#fav_star_button_link").attr("href","javascript:(function(){toggleFavorite('" + recordId + "');})()");
				$("#favorite_book_button").attr("href","javascript:(function(){toggleFavorite('" + recordId + "');})()");
				if (data.result.documents[0].lending_status == "UTL") {
					$("#status_indicators").addClass("book_unavailable").removeClass("book_available").removeClass("book_ordered");
					$("#button_where_is_it").addClass("ui-disabled");
				} else if (data.result.documents[0].status == "best" || data.result.documents[0].status == "akset") {
					$("#status_indicators").addClass("book_ordered").removeClass("book_available").removeClass("book_unavailable");
					$("#button_where_is_it").addClass("ui-disabled");
				} else {
					$("#status_indicators").addClass("book_available").removeClass("book_unavailable").removeClass("book_ordered");
					$("#button_where_is_it").removeClass("ui-disabled");
				}
				
				if (window.BookWorms.currentBook["material"] == "electronic") {
					$("#button_where_is_it").hide();
					$("#button_how_to_access").show();
				} else {
					$("#button_where_is_it").show();
					$("#button_how_to_access").hide();
					//console.log(data.result.documents[0]);
					var locinfo = getSectionForCurrentBook();
					$("#book_map").attr("src", "images/hylle" + locinfo[0] + ".png" );
					$("#book_shelf_map").attr("src", "images/shelf" + locinfo[1] + ".png" );
					var s = $("#directions_bookinfo_template").html();
					var t = Handlebars.compile(s);
					data.result.documents[0]["shelf"] = locinfo[1];
					var h = t(data.result.documents[0]);
					$("#directions_book_info").html(h);		
				}

				var newoptions = {dataUrl : urlObj.href, allowSamePageTransition : true};
				$.extend(options,newoptions);
				// console.log(options);
				// console.log(window.BookWorms.currentBook);
				$.mobile.changePage( $page, options );
			}
		
			function toggleFavorite(recordId) {
				//console.log(recordId);
				var fav = false;
				DB.exists(recordId, function(exists) {
					//console.log(exists);
					if(exists) {
						this.remove(recordId);
						FavHistory = $.grep(FavHistory, function(val) {
							return val !== recordId;
						});
					} else {
						//console.log(recordId);
						//console.log(window.BookWorms.searchCache[recordId+""]);
						this.save({key:recordId,doc:window.BookWorms.searchCache[recordId+""]});
						FavHistory.unshift(recordId);
						if (FavHistory.length > 15) {
							FavHistory.pop();
						}
						fav = true;
					}
				});

				DB.save({key:"favhistory", history: FavHistory});
				//XXX totally broken
				$("#fav_star_button").attr("src", fav ? "star.png" : "star_empty.png"); 
				$("#favorite_book_button").find(".ui-icon").toggleClass("ui-icon-plus").toggleClass("ui-icon-minus");
			}
		
			$('#search_button').bind('click', function (e) {
				e.preventDefault();
				var term = $('#searchinput1').val();
				//console.log(term);
				if (term == "")
					return false;
				if (window.a)
					window.a.container.hide();
				
				$.mobile.changePage(getAppSearchUrl(term,0));
				return false;
			});
			
			$("#scan_ok_button").bind("click", function (e) {
				//console.log(1);
				scanNow();
			});
			
			$("#search_page_form").submit(function(e){
				if(window.a)
					window.a.container.hide();
				e.preventDefault();
				return false;
			});
			
			
			$('#search_page_form').submit(function() {
				$("#search_button").trigger("click");
			});


			
			function getAppSearchUrl(term, page) {
				return "#page_search_results?term=" + encodeURIComponent(term) + "&page=" + page;
			}
			
			//XXX no results needs handling
			//XXX pressing enter should start search
			function getSearchResults(urlObj, options) {
				if (urlObj.hash.indexOf("?") == -1) {
					showSearchResults(undefined,undefined,undefined,urlObj,options);
					return;
				}
				var query = urlObj.hash.split("?")[1];
				var parameters = query.split("&");
				var term = parameters[0].split("=")[1];
				var page = parameters[1].split("=")[1];
				//XXX add timestamp
				
				var url;
				
				if (window.BookWorms.includeEbooks == "off") {
					//url = "https://ask.bibsys.no/ask2/json/result.jsp?jsonp=?" + "&cql=" + term + '%20AND%20(bs.avdeling%20=%20"UREAL")&page=' + page;
					url = "https://ask.bibsys.no/ask2/json/result.jsp?" + window.JSONP + "&cql=" + term + '%20AND%20(bs.avdeling%20=%20"UREAL")&page=' + page;
				} else {
					//url = "https://ask.bibsys.no/ask2/json/result.jsp?jsonp=?" + "&cql=" + term + '%20AND%20(bs.avdeling%20=%20"UREAL"%20OR(bs.bibkode%20=%20"k"%20AND%20bs.form%20=%20"n"))&page=' + page;
					url = "https://ask.bibsys.no/ask2/json/result.jsp?" + window.JSONP + "&cql=" + term + '%20AND%20(bs.avdeling%20=%20"UREAL"%20OR(bs.bibkode%20=%20"k"%20AND%20bs.form%20=%20"n"))&page=' + page;
				}
				
				$.getJSON(url, function (data) {
					showSearchResults(data,term,page,urlObj,options,decodeURIComponent(term));
				});				
			}
			
			function showSearchResults(data,term,pagenr,urlObj,options,query) {
				if (term != undefined) {
					var totalResults = data.result.totalHits;
					//console.log(data);
					/*
					if (totalResults == 0) {
						$("#no_books").html('No search results found for "' + query + '", check your spelling or try a less specific search.');
						return;
					}
					*/
				
					var prev = parseInt(pagenr) > 0 ? true : false;
					var prevUrl = getAppSearchUrl(decodeURIComponent(term), parseInt(pagenr) - 1);
					var next = totalResults - (parseInt(pagenr) + 1) * 10 > 0 ? true : false;
					var nextUrl = getAppSearchUrl(decodeURIComponent(term),parseInt(pagenr) + 1);
				}
				
				var $page = $("#page_search_results");
				
				if(term!=undefined) {
				
					var source = $("#search_result_book_template").html();
					var template = Handlebars.compile(source);

					data.result.query = query;
					var html = template(data.result);
				} else {
					var html = "";
					
				}
				$page.page();
				
				if (term == undefined || totalResults > 0) 
					$("#no_books").hide();
				else
					$("#no_books").show();
				
				$("#search_button").removeClass("ui-btn-active");
				//$(document).scrollTop(0);
				
				if (term != undefined) {
					$("#search_results_nav").show();
					$('#searchinput1').val(decodeURIComponent(term));
					$("#search_results_container").html(html).find( ":jqmData(role=listview)" ).listview();
				
					$("#prev_search_button").css("visibility", prev ? "visible" : "hidden").attr("href",prevUrl).removeClass("ui-btn-active");
					$("#next_search_button").css("visibility", next ? "visible" : "hidden").attr("href",nextUrl).removeClass("ui-btn-active");
					if (totalResults > 0) {
						$("#search_page_nr").show();
					} else {
						$("#search_page_nr").hide();
					}
					$("#search_page_nr").html(parseInt(pagenr) + 1 + " / " + parseInt(Math.ceil(totalResults/10)));
				
					//window.BookWorms.searchCache = {};
					$.each(data.result.documents, function(index,val) {
						window.BookWorms.searchCache[val.recordId] = val;
					});
					$.extend(options, {dataUrl : urlObj.href, allowSamePageTransition : true, transition:"none"});
					//console.log(urlObj.href);
					//if (window.BookWorms.nextPage == urlObj.href)
						$.mobile.changePage( $page, options );	
				} else {
					$("#search_results_container").html(html);
					$('#searchinput1').val("");
					$("#search_results_nav").hide();
					$.extend(options, {dataUrl : urlObj.href, allowSamePageTransition : true, transition:"slide"});
					//console.log(urlObj.href);
					//if (window.BookWorms.nextPage == urlObj.href)
						$.mobile.changePage( $page, options );	
				}			
			}
			
			function updateHomeFavorites() {
				//console.log(window.FavHistory);
				var favs = [];
				$.each(window.FavHistory, function (i, el) {
					if (i<3) {
						favs.push(window.BookWorms.searchCache[el]);
					} else {
						return false;
					}
				});
				
				//var $page = $("#page_search_results");
				var source = $("#home_favorites_template").html();
				var template = Handlebars.compile(source);
				var html = template({favorites:favs});
				
				var list = $("#home_favorites").html(html);
				if (list.hasClass('ui-listview')) {
					list.listview('refresh');
				}
			}
			
			function showFavorites(urlObj, options) {
				window.favs;
				DB.where('record.doc != undefined').asc('doc.title','window.favs = records');
				//a;
				//console.log(favs);
				function SortByTitle(a, b){
				  var aName = a.doc.title.toLowerCase();
				  var bName = b.doc.title.toLowerCase(); 
				  return ((aName < bName) ? -1 : ((aName > bName) ? 1 : 0));
				}

				favs.sort(SortByTitle);
				//console.log(favs);
				var docs = $.map (favs, function (el,i) {
					return el.doc;
				});
				//console.log(docs);
				var $page = $("#page_favorites");
				var source = $("#favorites_list_template").html();
				var template = Handlebars.compile(source);
				var html = template({documents:docs});
				$page.page();
				$("#favlist_container").html(html).find( ":jqmData(role=listview)" ).listview();				
			}
			
			function updateFavDeleteDialog(urlObj, options) {
				
				//console.log(1);
				var favid = urlObj.hash.split("?")[1];
				//console.log(favid);
				DB.get(favid, function(d) {
					//console.log(d);
					//console.log(d.doc.title);
					$("#delete_book_title").html(d.doc.title);	
					
				});
				
				//$("#fav_delete_button").attr("href","javascript:(function(){toggleFavorite('" + favid + "');return false;})()");
				$("#fav_delete_button").unbind("click").click(function(e){
					toggleFavorite(favid);
					//return false;
				});
			}
			
			window.NoBarCodeHelp = false;
			
			function scanBarcode() {
				if (window.NoBarCodeHelp) {
					scanNow();
				} else {
					$.mobile.changePage("#how_to_scan", {transition: 'none', role: 'dialog'});
				}
				
			}
			
		    function scanNow() {
        		window.plugins.barcodeScanner.scan(
        			function(result) {
            	    	//alert("We got a barcode\n" + "Result: " + result.text + "\n" + "Format: " + result.format); 
            	    	console.log(0);
						$("#searchinput1").val(result.text);
						$("#search_button").click();
            		}, 
            		function(error) {
                		alert("Scanning failed: " + error);
            	});
    		}			
			
			function shareBook() {
				var book = window.BookWorms.currentBook;
				
				var authors = book.creators.map(function(item) {
					return item.presentableName;
				}).join(", ");				
				
				var isbn = book.isbn.map(function(item) {
					return item;
				}).join(", ");
								
				var url = "http://openurl.bibsys.no/bibsysx/openurl?" + book.openurlRepresentation;
				
				window.plugins.share.show({
				    subject: book.title,
				    text: book.title + ' by ' + authors + ".\n\n ISBN:" + isbn + ".\n\n" + url },
				    function() {}, // Success function
				    function() {alert('Share failed')} // Failure function
				
				);
			}
			
			$("#ebook_toggle").change(function() {
				window.BookWorms.includeEbooks = $(this).val();
				DB.save({key:"includeebooks", status: $(this).val()});
			});
			
			
			$('#checkbox-scanhelp').change(function() {
				window.NoBarCodeHelp = !window.NoBarCodeHelp;
			});
			
	/*		
			var options,a;
			jQuery(function(){
			var options = {'serviceUrl' : "https://ask.bibsys.no/ask2/json/autocompleteProxy.jsp?jsonp=?","index":"title"}
				window.a = $("#searchinput1").autocomplete(options);
			});
			*/
		</script>
		<!--
		<script src="http://debug.shadow.adobe.com:8080/target/target-script-min.js#saq"></script>
		-->
	</body>

</html>
